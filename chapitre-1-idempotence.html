<style>
  h1, h2, h3 { font-family: sans-serif; }
  pre code {
    display: block;
    background-color: #f5f5f5;
    color: #222;
    padding: 1rem;
    border-radius: 6px;
    overflow-x: auto;
    font-family: Consolas, monospace;
  }
</style>

<h1 id="idempotence">Chapitre 1 â€“ Lâ€™idempotence</h1>

<p>
Stripe traite des millions de paiements chaque jour. Un clic de trop, un rÃ©seau instable ou un bug client peut gÃ©nÃ©rer plusieurs requÃªtes identiques.  
Sans prÃ©caution, cela entraÃ®ne des paiements en double, des expÃ©ditions rÃ©pÃ©tÃ©es, et une perte de confiance.  
Pour Ã©viter cela, Stripe sâ€™appuie sur un principe fondamental : <strong>lâ€™idempotence</strong>.
</p>

---

<h2 id="definition">1. DÃ©finition de lâ€™idempotence</h2>

<p>
Une opÃ©ration est dite <strong>idempotente</strong> si elle produit le mÃªme effet, quâ€™elle soit exÃ©cutÃ©e une ou plusieurs fois avec les mÃªmes paramÃ¨tres.
</p>

<pre><code class="language-http">
POST /charge
Idempotency-Key: 123e4567-e89b-12d3-a456-426614174000

{ "amount": 1000, "currency": "usd" }
</code></pre>

<p>
Dans cet exemple, mÃªme si cette requÃªte est renvoyÃ©e 3 fois, Stripe ne crÃ©era <strong>quâ€™un seul paiement</strong>.
</p>

---

<h2 id="pourquoi">2. Pourquoi lâ€™idempotence est-elle critique ?</h2>

<ul>
  <li>âœ… EmpÃªche les <strong>paiements en double</strong></li>
  <li>âœ… Ã‰vite les erreurs dâ€™infrastructure distribuÃ©e</li>
  <li>âœ… ProtÃ¨ge contre les clics rÃ©pÃ©tÃ©s de lâ€™utilisateur</li>
  <li>âœ… Rend les APIs robustes face aux retries automatiques</li>
</ul>

---

<h2 id="mecanisme">3. Comment Stripe gÃ¨re-t-il lâ€™idempotence ?</h2>

<ol>
  <li><strong>ClÃ© dâ€™idempotence</strong> gÃ©nÃ©rÃ©e cÃ´tÃ© client (UUID)</li>
  <li><strong>Transmission via en-tÃªte HTTP</strong></li>
  <li><strong>Stockage de lâ€™effet</strong> cÃ´tÃ© serveur, liÃ© Ã  la clÃ©</li>
  <li><strong>Rejet silencieux</strong> si la mÃªme clÃ© revient</li>
  <li><strong>ClÃ© invalide si les donnÃ©es changent</strong></li>
  <li><strong>Expiration aprÃ¨s 24h</strong> pour nettoyage</li>
</ol>

---

<h2 id="grace">4. Exponential backoff & jitter</h2>

<p>
En cas dâ€™Ã©chec rÃ©seau, Stripe recommande :
</p>

<pre><code class="language-pseudo">
retry after: random_between(2^n, 2^(n+1)) + jitter
</code></pre>

<p>
Ce mÃ©canisme Ã©vite la surcharge du serveur lors dâ€™une panne partielle (thundering herd).
</p>

---

<h2 id="conclusion">5. Conclusion</h2>

<blockquote>
<strong>Une API de paiement sans idempotence est dangereuse.</strong>  
Stripe en a fait une exigence absolue dans toutes ses intÃ©grations critiques.
</blockquote>

<p>
Chaque point de terminaison sensible (crÃ©ation de paiement, de remboursement, etc.) est conÃ§u pour Ãªtre idempotent.  
Cela garantit une expÃ©rience fluide, mÃªme en cas de panne ou dâ€™instabilitÃ© rÃ©seau.
</p>

---

<h2 id="exercice">ğŸ“ Exercice</h2>

<p>
1. CrÃ©e une API simple avec `POST /checkout` en Node.js ou FastAPI  
2. Ajoute un en-tÃªte `Idempotency-Key`  
3. Garde en mÃ©moire les clÃ©s utilisÃ©es  
4. Si une mÃªme clÃ© revient, retourne le mÃªme rÃ©sultat sans retraitement  
5. Ajoute un rollback transactionnel si une erreur survient
</p>
