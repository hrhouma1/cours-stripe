<style>
  h1, h2, h3 { font-family: sans-serif; }
  pre code {
    display: block;
    background-color: #f5f5f5;
    color: #222;
    padding: 1rem;
    border-radius: 6px;
    overflow-x: auto;
    font-family: Consolas, monospace;
  }
</style>

<h1 id="acid">Chapitre 2 â€“ Transactions ACID & Rollbacks</h1>

<p>
Lorsquâ€™un utilisateur effectue un paiement, plusieurs opÃ©rations critiques doivent se produire : dÃ©bit bancaire, crÃ©ation de commande, gÃ©nÃ©ration de facture, envoi dâ€™e-mail.  
Si lâ€™une dâ€™elles Ã©choue, <strong>lâ€™ensemble du processus doit Ãªtre annulÃ© proprement</strong>.  
Câ€™est lâ€™objectif des transactions <strong>ACID</strong>.
</p>

---

<h2 id="definition">1. Quâ€™est-ce quâ€™une transaction ACID ?</h2>

<p>
Une transaction est une sÃ©quence dâ€™opÃ©rations sur une base de donnÃ©es, qui respecte les 4 propriÃ©tÃ©s suivantes :
</p>

<ul>
  <li><strong>A â€“ AtomicitÃ©</strong> : tout ou rien</li>
  <li><strong>C â€“ CohÃ©rence</strong> : les rÃ¨gles mÃ©tier sont toujours valides</li>
  <li><strong>I â€“ Isolation</strong> : les transactions ne se perturbent pas entre elles</li>
  <li><strong>D â€“ DurabilitÃ©</strong> : une fois validÃ©e, elle est permanente</li>
</ul>

<p>
Ces garanties permettent dâ€™exÃ©cuter un paiement en toute sÃ©curitÃ©, mÃªme si un bug ou une coupure survient Ã  mi-parcours.
</p>

---

<h2 id="rollback">2. Exemple avec rollback</h2>

<p>
Imaginons une API de paiement avec trois Ã©tapes :
</p>

<ol>
  <li>DÃ©biter la carte</li>
  <li>CrÃ©er une commande</li>
  <li>Envoyer une facture</li>
</ol>

<p>Voici une implÃ©mentation typique (simplifiÃ©e en pseudocode) :</p>

<pre><code class="language-python">
with db.transaction():
    charge_user_card()
    create_order_record()
    send_invoice_email()
</code></pre>

<p>
Si l'envoi de lâ€™e-mail Ã©choue, la transaction est annulÃ©e. Aucune commande ne reste en base, aucun dÃ©bit nâ€™est visible.
</p>

---

<h2 id="stripe">3. ACID chez Stripe</h2>

<p>
Stripe ne stocke pas directement vos transactions dans une base SQL, mais il applique les principes ACID :
</p>

<ul>
  <li>Si un paiement est crÃ©Ã©, tous les effets associÃ©s sont garantis ou annulÃ©s</li>
  <li>En cas de double appel, seul le premier est appliquÃ© (voir idempotence)</li>
  <li>Stripe ne confirme jamais un succÃ¨s tant que le processus n'est pas complet</li>
</ul>

<p>
Ce modÃ¨le garantit la <strong>cohÃ©rence forte</strong> de bout en bout, mÃªme dans des systÃ¨mes distribuÃ©s.
</p>

---

<h2 id="bonus">4. Bonus : annuler proprement</h2>

<p>
Si une Ã©tape Ã©choue (ex. paiement acceptÃ© mais commande non enregistrÃ©e), Stripe recommande de :
</p>

<ul>
  <li>Utiliser un <code>rollback()</code> transactionnel dans votre base</li>
  <li>Consigner lâ€™erreur dans un <code>event log</code> pour reprise manuelle</li>
  <li>Notifier lâ€™utilisateur si une incohÃ©rence potentielle est dÃ©tectÃ©e</li>
</ul>

---

<h2 id="conclusion">5. Conclusion</h2>

<blockquote>
<strong>Une architecture sÃ©rieuse ne peut se permettre dâ€™Ã©checs partiels.</strong>  
Les transactions ACID vous protÃ¨gent contre les effets de bord non contrÃ´lÃ©s.
</blockquote>

<p>
Stripe applique ces principes dans tous ses services critiques.  
En tant que dÃ©veloppeur, vous devez les reproduire dans vos propres systÃ¨mes clients et backend.
</p>

---

<h2 id="exercice">ğŸ“ Exercice</h2>

<p>
1. ImplÃ©mente une API de paiement avec :
</p>

<ul>
  <li>Une base PostgreSQL ou SQLite</li>
  <li>Une route <code>POST /pay</code></li>
  <li>3 actions dans une transaction : Ã©criture, validation, notification</li>
  <li>Un bloc <code>try/except</code> avec <code>rollback()</code> en cas dâ€™erreur</li>
  <li>Une rÃ©ponse claire : succÃ¨s ou Ã©chec global</li>
</ul>
